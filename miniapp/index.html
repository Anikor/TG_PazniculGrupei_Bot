<?php
// miniapp/index.html


require_once __DIR__ . '/../config.php';
require_once __DIR__ . '/../db.php';

// ─── CORS & PRELIGHT ─────────────────────────
header('Access-Control-Allow-Origin: *');
header('Access-Control-Allow-Headers: Content-Type');
header('Access-Control-Allow-Methods: GET, POST, OPTIONS');
if ($_SERVER['REQUEST_METHOD'] === 'OPTIONS') exit;

// ─── AJAX SAVE ────────────────────────────────
if ($_SERVER['REQUEST_METHOD'] === 'POST'
  && str_contains($_SERVER['CONTENT_TYPE'] ?? '', 'application/json')
) {
  header('Content-Type: application/json; charset=UTF-8');
  $raw  = file_get_contents('php://input');
  $data = json_decode($raw, true);

  if (!$data || !isset($data['attendance']) || !isset($_GET['tg_id'])) {
    http_response_code(400);
    echo json_encode(['success'=>false,'error'=>'Invalid request']);
    exit;
  }

  // Lookup teacher
  $tg_id = intval($_GET['tg_id']);
  $user  = getUserByTgId($tg_id);
  if (!$user) {
    http_response_code(400);
    echo json_encode(['success'=>false,'error'=>'Unknown user']);
    exit;
  }



  // Compute date
  $offset = intval($_GET['offset'] ?? 0);
  $date   = date('Y-m-d', strtotime("$offset days"));

  // Insert statements
  $stmt = $pdo->prepare("
    INSERT INTO attendance
      (user_id, schedule_id, date, present, motivated, motivation, marked_by)
    VALUES
      (:uid, :sid, :dt, :pres, :mot, :reason, :mb)
  ");

  foreach ($data['attendance'] as $r) {
    $stmt->execute([
      ':uid'    => $r['user_id'],
      ':sid'    => $r['schedule_id'],
      ':dt'     => $date,
      ':pres'   => $r['present']   ? 1 : 0,
      ':mot'    => $r['motivated'] ? 1 : 0,
      ':reason' => $r['motivation'] ?: null,
      ':mb'     => $user['id'],
    ]);
  }

  echo json_encode(['success'=>true]);
  exit;
}

// ─── PAGE RENDER ──────────────────────────────

$tg_id   = intval($_GET['tg_id']  ?? 0);
$offset  = intval($_GET['offset'] ?? 0);
$date    = date('Y-m-d', strtotime("$offset days"));
$dayLabel = match (true) {
  $offset ===  0 => 'Today',
  $offset === -1 => 'Yesterday',
  default        => abs($offset) . ' days ago'
};
$prev1 = $offset - 1;
$prev2 = $offset - 2;
$next1 = $offset + 1;

// Data
$user     = getUserByTgId($tg_id) ?: exit('Invalid user');
$schedule = getScheduleForDate($tg_id, $date);
$students = getGroupStudents($user['group_id']);

// Existing attendance lookup
$sids = array_column($schedule, 'id');
$existing = [];
$markers  = [];
if ($sids) {
  $in = implode(',', array_fill(0, count($sids), '?'));
  $q  = "SELECT schedule_id,user_id,present,motivated,motivation,marked_by
           FROM attendance
          WHERE date=?
            AND schedule_id IN($in)";
  $stmt = $pdo->prepare($q);
  $stmt->execute(array_merge([$date], $sids));
  $teacher_ids = [];
  while ($r = $stmt->fetch(PDO::FETCH_ASSOC)) {
    $existing[$r['schedule_id']][$r['user_id']] = $r;
    $teacher_ids[] = $r['marked_by'];
  }
  if ($teacher_ids) {
    $teacher_ids = array_unique($teacher_ids);
    $in2 = implode(',', array_fill(0, count($teacher_ids), '?'));
    $stm2 = $pdo->prepare("SELECT id,name FROM users WHERE id IN($in2)");
    $stm2->execute($teacher_ids);
    while ($m = $stm2->fetch(PDO::FETCH_ASSOC)) {
      $markers[$m['id']] = $m['name'];
    }
  }
}

// Group name
$stmt = $pdo->prepare("SELECT name FROM `groups` WHERE id=?");
$stmt->execute([$user['group_id']]);
$grp       = $stmt->fetch(PDO::FETCH_ASSOC);
$groupName = $grp['name'] ?? 'Group ' . $user['group_id'];
?>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Log Attendance</title>
      <script>
  try {
    const html = document.documentElement;
    html.classList.add('js-ready');
    if (localStorage.getItem('theme') === 'dark') {
      html.classList.add('dark-theme');
    }
  } catch (e) {}
  </script>
  <style>
    /* Theme & layout */
    :root {
      --bg:#fff; --fg:#000; --bd:#ccc;
      --sec:#f5f5f5; --btn:#2a9df4; --btnfg:#fff;
    }
    .dark-theme {
      --bg:#2b2d2f; --fg:#e2e2e4; --bd:#444;
      --sec:#3b3f42; --btn:#1a73e8; --btnfg:#fff;
    }
      #theme-switch { visibility: hidden; }
html.js-ready #theme-switch { visibility: visible; }
    body {
      margin:0; padding:10px;
      font-family:sans-serif;
      background:var(--bg);
      color:var(--fg);
    }
    table {
      width:100%; border-collapse:collapse; margin-top:10px;
    }
    th, td {
      border:1px solid var(--bd);
      padding:8px; text-align:center;
    }
    th { background:var(--sec); }
    .btn-submit, .btn-edit {
      margin-top:15px;
      padding:10px 20px;
      border:none; border-radius:5px;
      background:var(--btn);
      color:var(--btnfg);
      cursor:pointer;
    }
    .btn-nav {
      margin:4px 6px 4px 0;
      padding:6px 12px;
      border:none; border-radius:4px;
      background:var(--sec);
      color:var(--fg);
      cursor:pointer;
    }
    /* Slider */
    .switch { position:relative; display:inline-block; width:50px; height:24px; }
    .switch input { opacity:0; width:0; height:0; }
    .slider {
      position:absolute; top:0; left:0; right:0; bottom:0;
      background:#ef5350; border-radius:24px; transition:.4s;
    }
    .slider:before {
      content:""; position:absolute;
      width:18px; height:18px;
      left:3px; bottom:3px;
      background:#fff; border-radius:50%; transition:.4s;
    }
    input:checked + .slider { background:#66bb6a; }
    input:checked + .slider:before { transform:translateX(26px); }
    /* Disabled-but-colored */
    input:disabled:not(:checked) + .slider { background:#e57373; }
    input:checked:disabled + .slider        { background:#a5d6a7; }
    .mot-reason {
      font-size:0.85em; color:var(--fg); margin-top:4px;
    }
    #save-confirm {
      display:none; margin-top:15px;
      padding:10px; background:#d4edda; color:#155724;
      border:1px solid #c3e6cb; border-radius:4px;
    }
  </style>
</head>
<body>

  <!-- Theme toggle -->
  <div id="theme-switch">
<label class="switch">
       <input type="checkbox" id="theme-toggle">
       <span class="slider"></span>
     </label>
     <span id="theme-label">Light</span>
  </div>

  <!-- Navigation -->
  <div>
    <button class="btn-nav" onclick="nav(<?= $prev2 ?>)">« <?= abs($prev2) ?>d</button>
    <button class="btn-nav" onclick="nav(<?= $prev1 ?>)">← <?= abs($prev1) ?>d</button>
    <?php if($offset!==0): ?>
      <button class="btn-nav" onclick="nav(0)">Today</button>
    <?php endif; ?>
    <?php if($offset < 0): ?>
      <button class="btn-nav" onclick="nav(<?= $next1 ?>)">→ 1d</button>
    <?php endif; ?>
    <button class="btn-nav" onclick="location.href='greeting.php?tg_id=<?= $tg_id ?>'">
      Back to Schedule
    </button>
  </div>

  <h2>Group: <?= htmlspecialchars($groupName,ENT_QUOTES) ?></h2>

  <?php if(empty($schedule)): ?>
    <p style="color:red;font-weight:bold;">
      No lessons for <?= $dayLabel ?> (<?= date('d.m.Y',strtotime($date)) ?>).
    </p>
  <?php else: ?>
    <table>
      <thead>
        <tr>
          <th>#</th><th>Student</th>
          <?php foreach($schedule as $s): ?>
            <th>
              <?= htmlspecialchars($s['time_slot'],ENT_QUOTES) ?><br>
              <?= htmlspecialchars($s['subject'],ENT_QUOTES) ?>
            </th>
          <?php endforeach; ?>
        </tr>
      </thead>
      <tbody>
        <?php foreach($students as $i=>$stu): ?>
        <tr>
          <td><?= $i+1 ?></td>
          <td><?= htmlspecialchars($stu['name'],ENT_QUOTES) ?></td>
          <?php foreach($schedule as $s): ?>
          <td>
            <?php if(isset($existing[$s['id']][$stu['id']])): 
              $a  = $existing[$s['id']][$stu['id']];
              $by = $markers[$a['marked_by']] ?? "ID{$a['marked_by']}";
            ?>
              <label class="switch">
                <input type="checkbox"
                       disabled
                       <?= $a['present'] ? 'checked':'' ?>>
                <span class="slider"></span>
              </label>
              <div class="mot-reason">
                <?php if($a['motivated']): ?>
                  Reason: <?= htmlspecialchars($a['motivation'],ENT_QUOTES) ?><br>
                <?php endif; ?>
                <em>By <?= htmlspecialchars($by,ENT_QUOTES) ?></em>
              </div>
            <?php else: ?>
              <label class="switch">
                <input type="checkbox"
                       class="att-toggle"
                       id="att_<?= $s['id'] ?>_<?= $stu['id'] ?>">
                <span class="slider"></span>
              </label>
              <div class="mot-container" id="mot_cont_<?= $s['id'] ?>_<?= $stu['id'] ?>">
                <label>
                  <input type="checkbox"
                         class="mot-toggle"
                         id="mot_<?= $s['id'] ?>_<?= $stu['id'] ?>">
                  Motivated
                </label>
                <input type="text"
                       id="mot_text_<?= $s['id'] ?>_<?= $stu['id'] ?>"
                       class="motiv-text"
                       placeholder="Reason…">
              </div>
            <?php endif; ?>
          </td>
          <?php endforeach; ?>
        </tr>
        <?php endforeach; ?>
      </tbody>
    </table>
        <div id="save-confirm">
      ✅ Attendance saved for <?= date('d.m.Y',strtotime($date)) ?>!
    </div>
 <?php if (empty($existing)): ?>
      <!-- no attendance exists yet, show the submit button -->
      <button class="btn-submit">Submit Attendance</button>
    <?php else: ?>
      <!-- attendance already saved, show an edit button instead -->
      <button
        class="btn-edit"
        onclick="location.href='edit_attendance.php?tg_id=<?= $tg_id ?>&offset=<?= $offset ?>'">
        Edit Attendance
      </button>
    <?php endif; ?>


  <?php endif; ?>

<script>
  // navigation helper
  function nav(off){
    location.search = `?tg_id=<?= $tg_id ?>&offset=${off}`;
  }

  // theme toggle
const toggle = document.getElementById('theme-toggle');
  const label  = document.getElementById('theme-label');
  const root   = document.documentElement;

  // initialize from localStorage
  (saved => {
    root.classList.toggle('dark-theme', saved === 'dark');
    label.textContent = saved === 'dark' ? 'Dark' : 'Light';
    toggle.checked = saved === 'dark';
  })(localStorage.getItem('theme') || 'light');

  // persist on change
  toggle.addEventListener('change', () => {
    const isDark = toggle.checked;
    root.classList.toggle('dark-theme', isDark);
    label.textContent = isDark ? 'Dark' : 'Light';
    localStorage.setItem('theme', isDark ? 'dark' : 'light');
  });

  // interactive sliders
  document.querySelectorAll('.att-toggle').forEach(chk=>{
    chk.addEventListener('change', ()=>{
      const id   = chk.id.replace('att_',''),
            cont = document.getElementById('mot_cont_'+id);
      cont.style.display = chk.checked ? 'none':'block';
    });
  });

  // wire-up mot-toggle
  document.querySelectorAll('.mot-toggle').forEach(chk=>{
    chk.addEventListener('change', ()=>{
      const id  = chk.id.replace('mot_',''),
            txt = document.getElementById('mot_text_'+id);
      if (chk.checked) txt.style.display='block';
      else { txt.style.display='none'; txt.value=''; }
    });
  });

  // initialize reason fields on every load
  document.querySelectorAll('.mot-toggle').forEach(chk=>{
    const id  = chk.id.replace('mot_',''),
          txt = document.getElementById('mot_text_'+id);
    if (chk.checked) {
      txt.style.display='block';
    } else {
      txt.style.display='none';
      txt.value='';
    }
  });

  // submit via AJAX
  document.querySelector('.btn-submit')?.addEventListener('click', async ()=>{
    const msg = `Submit attendance for <?= $dayLabel ?> (<?= date('d.m.Y',strtotime($date)) ?>)?`;
    if (!confirm(msg)) return;

    const out={attendance:[]};
    <?php foreach($schedule as $s): foreach($students as $u): ?>
      (() => {
        const el = document.getElementById('att_<?= $s['id'] ?>_<?= $u['id'] ?>');
        if (!el || el.disabled) return;
        const pres = el.checked;
        const mot  = !pres && document.getElementById('mot_<?= $s['id'] ?>_<?= $u['id'] ?>').checked;
        const rea  = mot ? document.getElementById('mot_text_<?= $s['id'] ?>_<?= $u['id'] ?>').value : '';
        out.attendance.push({
          schedule_id: <?= $s['id'] ?>,
          user_id:     <?= $u['id'] ?>,
          present:     pres,
          motivated:   mot,
          motivation:  rea
        });
      })();
    <?php endforeach; endforeach; ?>

    const url = `${location.origin}${location.pathname}${location.search}`;
    try {
      const resp = await fetch(url, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(out)
      });
      if (!resp.ok) throw new Error('HTTP '+resp.status);
      const txt = await resp.text();
      const m = txt.match(/\{[\s\S]*\}/);
      if (!m) throw new Error('Bad JSON');
      const j = JSON.parse(m[0]);
      if (j.success) {
        document.getElementById('save-confirm').style.display='block';
        document.querySelector('.btn-submit').disabled=true;
        document.querySelectorAll('.att-toggle,.mot-toggle').forEach(i=>i.disabled=true);
      } else {
        alert('Save failed: '+(j.error||'unknown'));
      }
    } catch(err) {
      console.error(err);
      alert('Network error: '+err.message);
    }
  });
</script>
</body>
</html>
