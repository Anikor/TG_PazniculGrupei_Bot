<?php
declare(strict_types=1);
function moderator_cutoff_from_schedule(array $schedule,DateTimeInterface $targetDate,?DateTimeZone $tz=null):?DateTimeImmutable{$tz=$tz?:new DateTimeZone('Europe/Chisinau');$baseYmd=$targetDate->format('Y-m-d');$maxEndTs=null;foreach($schedule as $row){if(!empty($row['end_time'])&&preg_match('/^(\d{1,2}):(\d{2})$/',(string)$row['end_time'],$m)){$dt=DateTimeImmutable::createFromFormat('Y-m-d H:i',$baseYmd.' '.$m[1].':'.$m[2],$tz);if($dt&&(!$maxEndTs||$dt>$maxEndTs))$maxEndTs=$dt;continue;}$slot=(string)($row['time_slot']??'');if($slot!==''){$slot=str_replace(['–','—','—'],'-',$slot);if(preg_match('/(\d{1,2}):(\d{2})\s*-\s*(\d{1,2}):(\d{2})/',$slot,$m)){$dt=DateTimeImmutable::createFromFormat('Y-m-d H:i',$baseYmd.' '.$m[3].':'.$m[4],$tz);if($dt&&(!$maxEndTs||$dt>$maxEndTs))$maxEndTs=$dt;}}}if(!$maxEndTs)return null;return $maxEndTs->modify('+20 minutes');}
function can_user_edit_for_date(string $role,DateTimeInterface $targetDate,?DateTimeZone $tz=null,array $schedule=[]):array{$tz=$tz?:new DateTimeZone('Europe/Chisinau');$now=new DateTimeImmutable('now',$tz);$role=strtolower(trim($role??''));if($role==='admin')return[true,''];if($role==='moderator'){$sameDay=$targetDate->format('Y-m-d')===$now->format('Y-m-d');if(!$sameDay)return[false,'Moderators can log/edit only for today.'];$cutoff=moderator_cutoff_from_schedule($schedule,$targetDate,$tz);if(!$cutoff){$cutoff=DateTimeImmutable::createFromFormat('Y-m-d H:i',$now->format('Y-m-d').' 18:00',$tz);} $ok=$now<=$cutoff;return[$ok,$ok?'':'The moderator window is closed (after last lesson + 20 min).'];}if($role==='monitor'){$today=new DateTimeImmutable($now->format('Y-m-d'),$tz);$minDate=$today->modify('-2 days');$ok=($targetDate>=$minDate)&&($targetDate<=$today);return[$ok,$ok?'':'Monitors can edit only today and the previous 2 days.'];}return[false,'Editing not permitted for your role.'];}