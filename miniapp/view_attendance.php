<?php require_once __DIR__.'/../config.php';require_once __DIR__.'/../db.php';if(!isset($_GET['tg_id']))die('Missing tg_id');$tg_id=intval($_GET['tg_id']);$user=getUserByTgId($tg_id);if(!$user)die('Unknown user');$user_id=$user['id'];$backUrl='greeting.php?tg_id='.$tg_id;if(isset($_GET['return'],$_GET['monitor_id'],$_GET['group_id'])&&$_GET['return']==='group'){$backUrl='view_group_attendance.php'.'?tg_id='.intval($_GET['monitor_id']).'&group_id='.intval($_GET['group_id']);}$today=date('Y-m-d');$weekStart=date('Y-m-d',strtotime('monday this week'));$monthStart=date('Y-m-01');function fetchStats($pdo,$uid,$from,$to=null){$params=[':uid'=>$uid,':from'=>$from];$cond="a.date >= :from";if($to!==null){$cond.=" AND a.date <= :to";$params[':to']=$to;}$totalQ=$pdo->prepare("
    SELECT COUNT(*) FROM attendance a
     WHERE a.user_id=:uid AND $cond
  ");$totalQ->execute($params);$total=(int)$totalQ->fetchColumn();$absQ=$pdo->prepare("
    SELECT COUNT(*) FROM attendance a
     WHERE a.user_id=:uid AND $cond AND a.present=0
  ");$absQ->execute($params);$absent=(int)$absQ->fetchColumn();$motQ=$pdo->prepare("
    SELECT COUNT(*) FROM attendance a
     WHERE a.user_id=:uid AND $cond AND a.present=0 AND a.motivated=1
  ");$motQ->execute($params);$motiv=(int)$motQ->fetchColumn();$lstQ=$pdo->prepare("
    SELECT a.date,
           s.time_slot,
           s.subject,
           s.type,
           a.motivation
      FROM attendance a
      JOIN schedule s ON s.id = a.schedule_id
     WHERE a.user_id=:uid
       AND $cond
       AND a.present=0
     ORDER BY a.date DESC, s.time_slot
  ");$lstQ->execute($params);$rows=$lstQ->fetchAll(PDO::FETCH_ASSOC);return['total'=>$total,'absent'=>$absent,'motivated'=>$motiv,'unmotiv'=>$absent-$motiv,'rows'=>$rows,];}$stats=['Today'=>fetchStats($pdo,$user_id,$today,$today),'This Week'=>fetchStats($pdo,$user_id,$weekStart,$today),'This Month'=>fetchStats($pdo,$user_id,$monthStart,$today),'All Time'=>fetchStats($pdo,$user_id,'1970-01-01',$today),];$all=$stats['All Time'];$labMissQ=$pdo->prepare("\n  SELECT COUNT(*) FROM attendance a\n  JOIN schedule s ON s.id=a.schedule_id\n  WHERE a.user_id=:uid AND a.present=0 AND s.type='lab'\n");$labMissQ->execute([':uid'=>$user_id]);$labMissCount=(int)$labMissQ->fetchColumn();$labFee=$labMissCount*50;$subjRows=$pdo->prepare("\n  SELECT s.subject, s.type,\n         COUNT(*) AS total,\n         SUM(a.present=0) AS absent\n    FROM attendance a\n    JOIN schedule s ON s.id=a.schedule_id\n   WHERE a.user_id=:uid\n   GROUP BY s.subject, s.type\n");$subjRows->execute([':uid'=>$user_id]);$subjStats=[];while($r=$subjRows->fetch(PDO::FETCH_ASSOC)){$sub=$r['subject'];$typ=$r['type'];$subjStats[$sub]['labels'][$typ]=['total'=>$r['total'],'absent'=>$r['absent'],];if(!isset($subjStats[$sub]['overall'])){$subjStats[$sub]['overall']=['total'=>0,'absent'=>0];}$subjStats[$sub]['overall']['total']+=$r['total'];$subjStats[$sub]['overall']['absent']+=$r['absent'];}$theme=(($_COOKIE['theme']?? 'light')==='dark')?'dark':'light'; ?><!doctypehtml><html class="<?=$theme==='dark'?'dark-theme':''?>"lang="en"><head><meta charset="UTF-8"><meta content="width=device-width,initial-scale=1"name="viewport"><title>My Attendance</title><link href="style.css"rel="stylesheet"></head><body><br><div id="theme-switch"><label class="switch"><input id="theme-toggle"type="checkbox"<?=$theme==='dark'?'checked':''?>> <span class="slider"></span></label> <span id="theme-label"><?=$theme==='dark'?'Dark':'Light'?></span></div><br><br><button class="btn-nav"onclick='location.href="<?=$backUrl?>"'>← Back</button><h1>My Attendance</h1><div class="cards"><?php foreach($stats as $label=>$st):$rate=$st['total']?round(100*$st['absent']/$st['total'],1):0; ?><div class="card"><h3><?=$label?></h3><p><strong>Sessions:</strong><?=$st['total']?></p><p><strong>Absent:</strong><?=$st['absent']?></p><p style="margin-left:12px">– unmotivated:<?=$st['unmotiv']?></p><p style="margin-left:12px">– motivated:<?=$st['motivated']?></p><p><strong>Absence Rate:</strong><?=$rate?>%</p><?php if($label==='All Time'): ?><hr><p><strong>Lab Misses:</strong><?=$labMissCount?></p><p><strong>Est. Fee:</strong><?=$labFee?>Lei</p><?php endif; ?></div><?php endforeach; ?></div><h2>By Subject Absence Rates</h2><table class="subj-table"><thead><tr><th>Subject</th><th>Curs Rate</th><th>Sem Rate</th><th>Lab Rate</th><th>Overall Rate</th></tr></thead><tbody><?php foreach($subjStats as $sub=>$data):$oTotal=$data['overall']['total'];$oAbsent=$data['overall']['absent'];$oRate=$oTotal?100*$oAbsent/$oTotal:0; ?><tr><td><?=htmlspecialchars($sub,ENT_QUOTES)?></td><?php foreach(['curs','sem','lab']as $t):$dTotal=$data['labels'][$t]['total']?? 0;$dAbsent=$data['labels'][$t]['absent']?? 0;$dRate=$dTotal?(100*$dAbsent/$dTotal):0; ?><td><?=$dAbsent?>/<?=$dTotal?>(<?=number_format($dRate,2)?>%)</td><?php endforeach; ?><td><?=$oAbsent?>/<?=$oTotal?>(<?=number_format($oRate,2)?>%)</td></tr><?php endforeach; ?></tbody></table><?php foreach($stats as $label=>$st):if(empty($st['rows']))continue; ?><h2><?=$label?>Absences</h2><table><thead><tr><th>Date</th><th>Time</th><th>Subject</th><th>Type</th><th>Reason</th></tr></thead><tbody><?php foreach($st['rows']as $r): ?><tr><td><?=htmlspecialchars($r['date'],ENT_QUOTES)?></td><td><?=htmlspecialchars($r['time_slot'],ENT_QUOTES)?></td><td><?=htmlspecialchars($r['subject'],ENT_QUOTES)?></td><td><?=htmlspecialchars($r['type'],ENT_QUOTES)?></td><td><?=$r['motivation']?htmlspecialchars($r['motivation'],ENT_QUOTES):'<em>none</em>'?></td></tr><?php endforeach; ?></tbody></table><?php endforeach; ?><script src="script.js"></script></body></html>