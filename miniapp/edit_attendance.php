<?php require_once __DIR__.'/../config.php';require_once __DIR__.'/../db.php';require_once __DIR__.'/oe_weeks.php';header('Access-Control-Allow-Origin: *');header('Access-Control-Allow-Headers: Content-Type');header('Access-Control-Allow-Methods: GET, POST, OPTIONS');if($_SERVER['REQUEST_METHOD']==='OPTIONS')exit;$tg_id=intval($_GET['tg_id']?? 0);$user=getUserByTgId($tg_id)?:exit('Invalid user');if(!in_array($user['role'],['admin','monitor','moderator'],true)){http_response_code(403);exit('Access denied');}$stmt=$pdo->prepare("SELECT name FROM `groups` WHERE id=?");$stmt->execute([$user['group_id']]);$grp=$stmt->fetch(PDO::FETCH_ASSOC);$groupName=$grp['name']?? 'Group '.$user['group_id'];$offset=intval($_GET['offset']?? 0);$date=date('Y-m-d',strtotime("$offset days"));$dayLabel=match(true){$offset===0=>'Today',$offset===-1=>'Yesterday',default=>abs($offset).' days ago'};$dt=new DateTime($date,new DateTimeZone('Europe/Chisinau'));[,,,$weekType]=computeSemesterAndWeek($dt);$schedule=getScheduleForDate($tg_id,$date,$weekType);if($_SERVER['REQUEST_METHOD']==='POST'&&str_contains($_SERVER['CONTENT_TYPE']?? '','application/json')){header('Content-Type: application/json; charset=UTF-8');$raw=file_get_contents('php://input');$data=json_decode($raw,true);if(!$data||!isset($data['attendance'])){http_response_code(400);echo json_encode(['success'=>false,'error'=>'Invalid payload']);exit;}$sel=$pdo->prepare("\n    SELECT id,present,motivated,motivation\n      FROM attendance\n     WHERE date=:dt AND schedule_id=:sid AND user_id=:uid\n    LIMIT 1\n  ");$upd=$pdo->prepare("\n    UPDATE attendance\n       SET present=:pres, motivated=:mot, motivation=:reason,\n           updated_at=NOW(), updated_by=:editor\n     WHERE id=:att_id\n  ");$log=$pdo->prepare("\n    INSERT INTO attendance_log\n      (attendance_id, changed_by,\n       old_present, new_present,\n       old_motivated, new_motivated,\n       old_motivation, new_motivation)\n    VALUES\n      (:att_id, :editor,\n       :old_pres, :new_pres,\n       :old_mot, :new_mot,\n       :old_reason, :new_reason)\n  ");$ins=$pdo->prepare("\n    INSERT INTO attendance\n      (user_id, schedule_id, date, present, motivated, motivation, marked_by)\n    VALUES\n      (:uid, :sid, :dt, :pres, :mot, :reason, :editor)\n  ");try{$pdo->beginTransaction();foreach($data['attendance']as $r){$sid=(int)$r['schedule_id'];$uid=(int)$r['user_id'];$sel->execute([':dt'=>$date,':sid'=>$sid,':uid'=>$uid]);$old=$sel->fetch(PDO::FETCH_ASSOC);$new_pres=!empty($r['present'])?1:0;$new_mot=!empty($r['motivated'])?1:0;$new_reason=trim((string)($r['motivation']?? ''))?:null;if(!$old){$ins->execute([':uid'=>$uid,':sid'=>$sid,':dt'=>$date,':pres'=>$new_pres,':mot'=>$new_mot,':reason'=>$new_reason,':editor'=>$user['id'],]);continue;}if($old['present']!=$new_pres||$old['motivated']!=$new_mot||$old['motivation']!==$new_reason){$log->execute([':att_id'=>$old['id'],':editor'=>$user['id'],':old_pres'=>$old['present'],':new_pres'=>$new_pres,':old_mot'=>$old['motivated'],':new_mot'=>$new_mot,':old_reason'=>$old['motivation'],':new_reason'=>$new_reason,]);$upd->execute([':pres'=>$new_pres,':mot'=>$new_mot,':reason'=>$new_reason,':editor'=>$user['id'],':att_id'=>$old['id'],]);}}$pdo->commit();echo json_encode(['success'=>true]);}catch(Throwable $e){if($pdo->inTransaction())$pdo->rollBack();http_response_code(500);echo json_encode(['success'=>false,'error'=>'DB error']);}exit;}$students=getGroupStudents($user['group_id']);$existing=[];$markers=[];$updaters=[];if(!empty($schedule)){$sids=array_column($schedule,'id');$in=implode(',',array_fill(0,count($sids),'?'));$q="SELECT schedule_id,user_id,present,motivated,motivation,
               marked_by,updated_at,updated_by
          FROM attendance
         WHERE date=? AND schedule_id IN($in)";$stmt=$pdo->prepare($q);$stmt->execute(array_merge([$date],$sids));$marker_ids=$editor_ids=[];while($r=$stmt->fetch(PDO::FETCH_ASSOC)){$existing[$r['schedule_id']][$r['user_id']]=$r;if(!empty($r['marked_by']))$marker_ids[]=$r['marked_by'];if(!empty($r['updated_by']))$editor_ids[]=$r['updated_by'];}$all_ids=array_values(array_unique(array_merge($marker_ids,$editor_ids)));if($all_ids){$in2=implode(',',array_fill(0,count($all_ids),'?'));$stm2=$pdo->prepare("SELECT id,name FROM users WHERE id IN($in2)");$stm2->execute($all_ids);while($u=$stm2->fetch(PDO::FETCH_ASSOC)){$markers[$u['id']]=$u['name'];$updaters[$u['id']]=$u['name'];}}}$theme=(($_COOKIE['theme']?? 'light')==='dark')?'dark':'light';$themeLabel=($theme==='dark')?'Dark':'Light'; ?><!doctypehtml><html class="<?=$theme==='dark'?'dark-theme':''?>"lang="en"><head><meta charset="UTF-8"><meta content="width=device-width,initial-scale=1"name="viewport"><title>Edit Attendance —<?=htmlspecialchars($dayLabel)?>(<?=date('d.m.Y',strtotime($date))?>)</title><link href="style.css?v=1"rel="stylesheet"><script defer src="script.js?v=nav-global-2"></script></head><body data-date-dmy="<?=htmlspecialchars(date('d.m.Y',strtotime($date)),ENT_QUOTES)?>"data-day-label="<?=htmlspecialchars($dayLabel,ENT_QUOTES)?>"data-page="edit"data-tg-id="<?=(int)$tg_id?>"><br><div id="theme-switch"><label class="switch"><input id="theme-toggle"type="checkbox"<?=$theme==='dark'?'checked':''?>> <span class="slider"></span></label> <span id="theme-label"><?=$themeLabel?></span></div><br><br><div class="page-header"><button class="btn-nav"onclick="history.back()">← Back</button></div><br><h2>Group:<?=htmlspecialchars($groupName,ENT_QUOTES)?></h2><br><h2>Edit attendance for<?=htmlspecialchars($dayLabel,ENT_QUOTES)?>(<?=date('d.m.Y',strtotime($date))?>)</h2><?php if(empty($schedule)): ?><p style="color:red">No lessons for this day.</p><?php else: ?><table><thead><tr><th><th>Student</th><?php foreach($schedule as $s): ?><th><?=htmlspecialchars($s['time_slot'])?><br><?=htmlspecialchars($s['subject'])?></th><?php endforeach; ?></tr></thead><tbody><?php foreach($students as $i=>$stu): ?><tr><td><?=$i+1?></td><td><?=htmlspecialchars($stu['name'])?></td><?php foreach($schedule as $s):$cell=$existing[$s['id']][$stu['id']]?? null;$pres=$cell?(int)$cell['present']:0;$mot=$cell?(int)$cell['motivated']:0;$txt=$cell?(string)($cell['motivation']?? ''):''; ?><td><label class="switch"><input id="att_<?=$s['id'].'_'.$stu['id']?>"class="att-toggle"type="checkbox"<?=$pres?'checked':''?>> <span class="slider"></span></label><div class="mot-container"id="mot_cont_<?=$s['id'].'_'.$stu['id']?>"><label><input id="mot_<?=$s['id'].'_'.$stu['id']?>"class="mot-toggle"type="checkbox"<?=$mot?'checked':''?>> Motivated</label> <input id="mot_text_<?=$s['id'].'_'.$stu['id']?>"class="motiv-text"placeholder="Reason…"value="<?=htmlspecialchars($txt,ENT_QUOTES)?>"></div><?php if($cell&&!empty($cell['updated_by'])): ?><div class="edit-info">Last edited by<?=htmlspecialchars($updaters[$cell['updated_by']]??('ID'.$cell['updated_by']),ENT_QUOTES)?>at<?=htmlspecialchars($cell['updated_at']?? '',ENT_QUOTES)?></div><?php endif; ?></td><?php endforeach; ?></tr><?php endforeach; ?></tbody></table><button class="btn-submit">Save changes</button><?php endif; ?></body></html>