<?php require_once __DIR__.'/../config.php';require_once __DIR__.'/../db.php';$tg_id=intval($_GET['tg_id']?? 0);$me=getUserByTgId($tg_id)?:die('Unknown user');if(!in_array($me['role'],['admin','monitor'],true)){die('Access denied');}$group_id=intval($_GET['group_id']?? $me['group_id']);$today=date('Y-m-d');$weekStart=date('Y-m-d',strtotime('monday this week'));$monthStart=date('Y-m-01');$periods=['Today'=>[$today,$today],'This Week'=>[$weekStart,$today],'This Month'=>[$monthStart,$today],'All Time'=>['1970-01-01',$today],];function fetchStats(PDO $pdo,$uid,$from,$to=null){$params=[':uid'=>$uid,':from'=>$from];$cond="a.date >= :from";if($to!==null){$cond.=" AND a.date <= :to";$params[':to']=$to;}$qTot=$pdo->prepare("SELECT COUNT(*) FROM attendance a WHERE a.user_id=:uid AND $cond");$qTot->execute($params);$total=(int)$qTot->fetchColumn();$qAbs=$pdo->prepare("SELECT COUNT(*) FROM attendance a WHERE a.user_id=:uid AND $cond AND a.present=0");$qAbs->execute($params);$absent=(int)$qAbs->fetchColumn();return[$total,$absent];}$stuQ=$pdo->prepare("\n  SELECT id, name, tg_id\n  FROM users\n  WHERE group_id = ?\n  ORDER BY name\n");$stuQ->execute([$group_id]);$students=$stuQ->fetchAll(PDO::FETCH_ASSOC);$stats=[];foreach($students as $stu){$sid=$stu['id'];foreach($periods as $lbl=>[$f,$t]){[$tot,$abs]=fetchStats($pdo,$sid,$f,$t);$stats[$sid][$lbl]=['total'=>$tot,'absent'=>$abs,'rate'=>$tot?round(100*($tot-$abs)/$tot,2):0,];}}$sum=[];foreach(array_keys($periods)as $lbl){$sum[$lbl]=['absent'=>0,'total'=>0];}foreach($students as $stu){$sid=$stu['id'];foreach(array_keys($periods)as $lbl){$sum[$lbl]['absent']+=$stats[$sid][$lbl]['absent'];$sum[$lbl]['total']+=$stats[$sid][$lbl]['total'];}}$summary=[];foreach($sum as $lbl=>$vals){$present=$vals['total']-$vals['absent'];$pct=$vals['total']?round(100*$present/$vals['total'],2):0;$summary[$lbl]=['present'=>$present,'total'=>$vals['total'],'pct'=>$pct,];}$theme=(($_COOKIE['theme']?? 'light')==='dark')?'dark':'light';$themeLabel=($theme==='dark')?'Dark':'Light';$groupName="Group {$group_id}";$gQ=$pdo->prepare("SELECT name FROM groups WHERE id=?");if($gQ->execute([$group_id])&&($n=$gQ->fetchColumn())){$groupName=$n;} ?><!doctypehtml><html class="<?=$theme==='dark'?'dark-theme':''?>"lang="en"><head><script src="script.js"></script><meta charset="utf-8"><meta content="width=device-width,initial-scale=1"name="viewport"><title>Group Attendance</title><link href="style.css"rel="stylesheet"></head><body><div id="theme-switch"><label class="switch"><input id="theme-toggle"type="checkbox"<?=$theme==='dark'?'checked':''?>> <span class="slider"></span></label> <span id="theme-label"><?=$themeLabel?></span></div><br><br><button class="btn-nav"onclick='location.href="greeting.php?tg_id=<?=(int)$tg_id?>&group_id=<?=(int)$group_id?>"'>← Back</button><h1>Group Attendance:<?=htmlspecialchars($groupName,ENT_QUOTES)?></h1><div class="stat-cards"><?php foreach($summary as $lbl=>$d): ?><div class="stat"><h3><?=htmlspecialchars($lbl,ENT_QUOTES)?></h3><p><?="{$d['present']}/{$d['total']} ({$d['pct']}%)"?></p></div><?php endforeach; ?></div><table><thead><tr><th><th>Student</th><?php foreach(array_keys($periods)as $lbl): ?><th><?=htmlspecialchars($lbl,ENT_QUOTES)?></th><?php endforeach; ?><th>View</th></tr></thead><tbody><?php $i=1;foreach($students as $stu):$sid=$stu['id']; ?><tr><td><?=$i++?></td><td class="stu-name"><?=htmlspecialchars($stu['name'],ENT_QUOTES)?></td><?php foreach(array_keys($periods)as $lbl):$r=$stats[$sid][$lbl]; ?><td><?="{$r['absent']}/{$r['total']} (".number_format($r['rate'],2)."%)"?></td><?php endforeach; ?><td><?php if(!empty($stu['tg_id'])): ?><?php $qs=http_build_query(['tg_id'=>$stu['tg_id'],'return'=>'group','monitor_id'=>$tg_id,'group_id'=>$group_id,]); ?><button class="btn-view"onclick='location.href="view_attendance.php?<?=$qs?>"'>View</button><?php else: ?>—<?php endif; ?></td></tr><?php endforeach; ?></tbody></table></body></html>